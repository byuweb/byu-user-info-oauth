{"version":3,"file":"byu-user-info-oauth.min.js","sources":["../node_modules/@byuweb/browser-oauth/byu-browser-oauth.js","../src/byu-user-info-oauth.js"],"sourcesContent":["/*\n * Copyright 2018 Brigham Young University\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const STATE_CHANGE_EVENT = `${EVENT_PREFIX}-state-changed`;\nexport const LOGIN_REQUESTED_EVENT = `${EVENT_PREFIX}-login-requested`;\nexport const LOGOUT_REQUESTED_EVENT = `${EVENT_PREFIX}-logout-requested`;\nexport const REFRESH_REQUESTED_EVENT = `${EVENT_PREFIX}-refresh-requested`;\nexport const STATE_REQUESTED_EVENT = `${EVENT_PREFIX}-state-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\nlet store = {state: STATE_INDETERMINATE};\n\nlet observer = onStateChange(detail => {\n    store = detail;\n});\n\nexport function onStateChange(callback) {\n    const func = function(e) {\n        callback(e.detail);\n    };\n    document.addEventListener(STATE_CHANGE_EVENT, func, false);\n    if (store.state === STATE_INDETERMINATE) {\n        dispatch(STATE_REQUESTED_EVENT, {callback});\n    } else {\n        callback(store);\n    }\n    return {\n        offStateChange: function() {\n            document.removeEventListener(STATE_CHANGE_EVENT, func, false);\n        }\n    }\n}\n\nexport function state() {\n    return store.state;\n}\n\nexport function hasToken() {\n    return !!store.token;\n}\n\nexport function token() {\n    return store.token;\n}\n\nexport function authorizationHeader() {\n    return store.token && store.token.authorizationHeader;\n}\n\nexport function user() {\n    return store.user;\n}\n\nexport function login() {\n    const promise = promiseState([STATE_AUTHENTICATED])\n    dispatch(LOGIN_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function logout() {\n    const promise = promiseState([STATE_UNAUTHENTICATED]);\n    dispatch(LOGOUT_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function refresh() {\n    const promise = promiseState([STATE_AUTHENTICATED, STATE_UNAUTHENTICATED]);\n    dispatch(REFRESH_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function teardown() {\n    observer.offStateChange();\n    store = {state: STATE_INDETERMINATE};\n}\n\nfunction promiseState(desiredStates) {\n    if (!window.Promise) {\n        return null;\n    }\n    return new Promise((resolve, reject) => {\n        const observer = onStateChange(({state, token, user, error}) => {\n            if (error) {\n                reject(error);\n                observer.offStateChange();\n            } else if (desiredStates.indexOf(state) >= 0) {\n                resolve({state, token, user});\n                observer.offStateChange();\n            }\n        });\n    });\n}\n\nfunction dispatch(name, detail) {\n    let event;\n    if (typeof window.CustomEvent === 'function') {\n        event = new CustomEvent(name, {detail});\n    } else {\n        event = document.createEvent('CustomEvent');\n        event.initCustomEvent(name, true, false, detail);\n    }\n    document.dispatchEvent(event);\n}\n\n","/*\n * Copyright 2018 Brigham Young University\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *    http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as authn from '../node_modules/@byuweb/browser-oauth/byu-browser-oauth.js';\n\nexport default class ByuUserInfoOAuth extends HTMLElement {\n    constructor() {\n        super();\n    }\n\n    connectedCallback() {\n        renderEmpty(this);\n        this._observer = authn.onStateChange(e => this.authStateChanged(e));\n    }\n\n    disconnectedCallback() {\n        if (this._observer) {\n            this._observer.offStateChange();\n        }\n        this._userInfo = null;\n    }\n\n    authStateChanged({state, token, user, error}) {\n        const userElement = this._userInfo.querySelector('[slot=\"user-name\"]');\n        const hasUserElement = !!userElement;\n        if (user) {\n            const el = hasUserElement ? userElement : this.ownerDocument.createElement('span');\n            el.setAttribute('slot', 'user-name');\n            el.innerText = user.name.displayName;\n\n            if (!hasUserElement) {\n                this._userInfo.appendChild(el);\n            }\n        } else if (hasUserElement) {\n            this._userInfo.removeChild(userElement);\n        }\n        //TODO: Handle error cases\n    }\n}\n\nwindow.customElements.define('byu-user-info-oauth', ByuUserInfoOAuth);\n\nfunction renderEmpty(el) {\n    const doc = el.ownerDocument;\n\n    const userInfo = doc.createElement('byu-user-info');\n\n    el._userInfo = userInfo;\n\n    const signIn = doc.createElement('a');\n    signIn.innerText = 'Sign In';\n    signIn.setAttribute('slot', 'login');\n    signIn.addEventListener('click', () => {\n        authn.login();\n    });\n\n    const signOut = doc.createElement('a');\n    signOut.innerText = 'Sign Out';\n    signOut.setAttribute('slot', 'logout');\n    signOut.addEventListener('click', () => {\n        authn.logout();\n    });\n\n    userInfo.appendChild(signIn);\n    userInfo.appendChild(signOut);\n\n    console.log('userInfo.children', userInfo.children);\n\n    el.appendChild(userInfo);\n}\n"],"names":["EVENT_PREFIX","STATE_CHANGE_EVENT","LOGIN_REQUESTED_EVENT","LOGOUT_REQUESTED_EVENT","STATE_REQUESTED_EVENT","STATE_INDETERMINATE","STATE_UNAUTHENTICATED","STATE_AUTHENTICATED","store","state","observer","onStateChange","detail","callback","func","e","document","addEventListener","dispatch","offStateChange","removeEventListener","login","promise","promiseState","logout","desiredStates","window","Promise","resolve","reject","token","user","error","indexOf","name","event","CustomEvent","createEvent","initCustomEvent","dispatchEvent","ByuUserInfoOAuth","HTMLElement","[object Object]","super","renderEmpty","this","_observer","authn.onStateChange","authStateChanged","_userInfo","userElement","querySelector","hasUserElement","el","ownerDocument","createElement","setAttribute","innerText","displayName","appendChild","removeChild","doc","userInfo","signIn","authn.login","signOut","authn.logout","console","log","children","customElements","define"],"mappings":"AAgBA,MAAaA,aAAe,oBAEfC,sBAAwBD,6BACxBE,yBAA2BF,+BAC3BG,0BAA4BH,gCAE5BI,yBAA2BJ,+BAE3BK,oBAAsB,gBACtBC,sBAAwB,kBACxBC,oBAAsB,gBAMnC,IAAIC,OAASC,MAAOJ,qBAEhBK,SAAWC,cAAcC,IACzBJ,MAAQI,IAGZ,SAAgBD,cAAcE,GAC1B,MAAMC,EAAO,SAASC,GAClBF,EAASE,EAAEH,SAQf,OANAI,SAASC,iBAAiBhB,mBAAoBa,GAAM,GAChDN,MAAMC,QAAUJ,oBAChBa,SAASd,uBAAwBS,SAAAA,IAEjCA,EAASL,QAGTW,eAAgB,WACZH,SAASI,oBAAoBnB,mBAAoBa,GAAM,KAyBnE,SAAgBO,QACZ,MAAMC,EAAUC,cAAchB,sBAE9B,OADAW,SAAShB,uBACFoB,EAGX,SAAgBE,SACZ,MAAMF,EAAUC,cAAcjB,wBAE9B,OADAY,SAASf,wBACFmB,EAcX,SAASC,aAAaE,GAClB,OAAKC,OAAOC,QAGL,IAAIA,QAAQ,CAACC,EAASC,KACzB,MAAMnB,EAAWC,cAAc,EAAEF,MAAAA,EAAOqB,MAAAA,EAAOC,KAAAA,EAAMC,MAAAA,MAC7CA,GACAH,EAAOG,GACPtB,EAASS,kBACFM,EAAcQ,QAAQxB,IAAU,IACvCmB,GAASnB,MAAAA,EAAOqB,MAAAA,EAAOC,KAAAA,IACvBrB,EAASS,sBATV,KAef,SAASD,SAASgB,EAAMtB,GACpB,IAAIuB,EAC8B,mBAAvBT,OAAOU,YACdD,EAAQ,IAAIC,YAAYF,GAAOtB,OAAAA,KAE/BuB,EAAQnB,SAASqB,YAAY,gBACvBC,gBAAgBJ,GAAM,GAAM,EAAOtB,GAE7CI,SAASuB,cAAcJ,SCzGNK,yBAAyBC,YAC1CC,cACIC,QAGJD,oBACIE,YAAYC,MACZA,KAAKC,UAAYC,cAAoBhC,GAAK8B,KAAKG,iBAAiBjC,IAGpE2B,uBACQG,KAAKC,WACLD,KAAKC,UAAU3B,iBAEnB0B,KAAKI,UAAY,KAGrBP,wBAAkBjC,QAAOqB,OAAOC,EAAIC,MAAEA,IAClC,MAAMkB,EAAcL,KAAKI,UAAUE,cAAc,sBAC3CC,IAAmBF,EACzB,GAAInB,EAAM,CACN,MAAMsB,EAAKD,EAAiBF,EAAcL,KAAKS,cAAcC,cAAc,QAC3EF,EAAGG,aAAa,OAAQ,aACxBH,EAAGI,UAAY1B,EAAKG,KAAKwB,YAEpBN,GACDP,KAAKI,UAAUU,YAAYN,QAExBD,GACPP,KAAKI,UAAUW,YAAYV,IAQvC,SAASN,YAAYS,GACjB,MAAMQ,EAAMR,EAAGC,cAETQ,EAAWD,EAAIN,cAAc,iBAEnCF,EAAGJ,UAAYa,EAEf,MAAMC,EAASF,EAAIN,cAAc,KACjCQ,EAAON,UAAY,UACnBM,EAAOP,aAAa,OAAQ,SAC5BO,EAAO9C,iBAAiB,QAAS,KAC7B+C,UAGJ,MAAMC,EAAUJ,EAAIN,cAAc,KAClCU,EAAQR,UAAY,WACpBQ,EAAQT,aAAa,OAAQ,UAC7BS,EAAQhD,iBAAiB,QAAS,KAC9BiD,WAGJJ,EAASH,YAAYI,GACrBD,EAASH,YAAYM,GAErBE,QAAQC,IAAI,oBAAqBN,EAASO,UAE1ChB,EAAGM,YAAYG,GA5BnBpC,OAAO4C,eAAeC,OAAO,sBAAuB/B"}