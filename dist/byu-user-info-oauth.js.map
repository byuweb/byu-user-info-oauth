{"version":3,"file":"byu-user-info-oauth.js","sources":["../node_modules/@byuweb/browser-oauth/constants.js","../node_modules/@byuweb/browser-oauth/byu-browser-oauth.js","../byu-user-info-oauth.js"],"sourcesContent":["export const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const EVENT_STATE_CHANGE = `${EVENT_PREFIX}-state-changed`;\nexport const EVENT_LOGIN_REQUESTED = `${EVENT_PREFIX}-login-requested`;\nexport const EVENT_LOGOUT_REQUESTED = `${EVENT_PREFIX}-logout-requested`;\nexport const EVENT_REFRESH_REQUESTED = `${EVENT_PREFIX}-refresh-requested`;\nexport const EVENT_CURRENT_INFO_REQUESTED = `${EVENT_PREFIX}-current-info-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\n","/*\n * Copyright 2018 Brigham Young University\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n    EVENT_STATE_CHANGE,\n    EVENT_LOGIN_REQUESTED,\n    EVENT_LOGOUT_REQUESTED,\n    EVENT_REFRESH_REQUESTED,\n    EVENT_CURRENT_INFO_REQUESTED,\n\n    STATE_INDETERMINATE,\n    STATE_AUTHENTICATED,\n    STATE_UNAUTHENTICATED,\n} from './constants.js';\n\nexport * from './constants.js';\n\nexport class AuthenticationObserver {\n    constructor(callback, { notifyCurrent = true } = {} ) {\n        this._listener = function (e) {\n            callback(e.detail);\n        };\n        document.addEventListener(EVENT_STATE_CHANGE, this._listener, false);\n        if (notifyCurrent) {\n            dispatch(EVENT_CURRENT_INFO_REQUESTED, { callback });\n        }\n    }\n\n    disconnect() {\n        document.removeEventListener(EVENT_STATE_CHANGE, this._listener, false);\n    }\n}\n\nasync function queryCurrentInfo() {\n    return new Promise((resolve, reject) => {\n        const callback = (detail) => {\n            if (detail.error) {\n                reject(detail.error);\n            } else {\n                resolve(detail);\n            }\n        };\n        dispatch(EVENT_CURRENT_INFO_REQUESTED, { callback });\n    });\n}\n\nexport async function state() {\n    const info = await queryCurrentInfo();\n    return info.state;\n}\n\nexport async function hasToken() {\n    return !!await token();\n}\n\nexport async function token() {\n    const info = await queryCurrentInfo();\n    return info.token;\n}\n\nexport async function authorizationHeader() {\n    const {token = {}} = await queryCurrentInfo();\n    return token.authorizationHeader;\n}\n\nexport async function user() {\n    const info = await queryCurrentInfo();\n    return info.user;\n}\n\nexport async function login() {\n    const promise = promiseState([STATE_AUTHENTICATED])\n    dispatch(EVENT_LOGIN_REQUESTED);\n    return promise;\n}\n\nexport async function logout() {\n    const promise = promiseState([STATE_UNAUTHENTICATED]);\n    dispatch(EVENT_LOGOUT_REQUESTED);\n    return promise;\n}\n\nexport async function refresh() {\n    const promise = promiseState([STATE_AUTHENTICATED, STATE_UNAUTHENTICATED]);\n    dispatch(EVENT_REFRESH_REQUESTED);\n    return promise;\n}\n\nfunction promiseState(desiredStates) {\n    if (!window.Promise) {\n        return {then: () => {}, catch: () => {}, finally: () => {}};\n    }\n    return new Promise((resolve, reject) => {\n        const observer = new AuthenticationObserver(({ state, token, user, error }) => {\n            if (error) {\n                reject(error);\n                observer.offStateChange();\n            } else if (desiredStates.indexOf(state) >= 0) {\n                resolve({ state, token, user });\n                observer.disconnect();\n            }\n        });\n    });\n}\n\nfunction dispatch(name, detail) {\n    let event;\n    if (typeof window.CustomEvent === 'function') {\n        event = new CustomEvent(name, { detail });\n    } else {\n        event = document.createEvent('CustomEvent');\n        event.initCustomEvent(name, true, false, detail);\n    }\n    document.dispatchEvent(event);\n}\n\n","/*\n * Copyright 2018 Brigham Young University\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *    http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as authn from './node_modules/@byuweb/browser-oauth/byu-browser-oauth.js';\n\nexport default class ByuUserInfoOAuth extends HTMLElement {\n    constructor() {\n        super();\n    }\n\n    connectedCallback() {\n        renderEmpty(this);\n        this._observer = new authn.AuthenticationObserver(e => this.authStateChanged(e));\n    }\n\n    disconnectedCallback() {\n        if (this._observer) {\n            this._observer.disconnect();\n            this._observer = null;\n        }\n        this._userInfo = null;\n    }\n\n    authStateChanged({ state, token, user, error }) {\n        const userElement = this._userInfo.querySelector('[slot=\"user-name\"]');\n        const hasUserElement = !!userElement;\n        if (user) {\n            const el = hasUserElement ? userElement : this.ownerDocument.createElement('span');\n            el.setAttribute('slot', 'user-name');\n            el.innerText = user.name.givenName;\n\n            if (!hasUserElement) {\n                this._userInfo.appendChild(el);\n            }\n        } else if (hasUserElement) {\n            this._userInfo.removeChild(userElement);\n        }\n        //TODO: Handle error cases\n    }\n}\n\nwindow.customElements.define('byu-user-info-oauth', ByuUserInfoOAuth);\n\nfunction renderEmpty(el) {\n    const doc = el.ownerDocument;\n\n    const userInfo = doc.createElement('byu-user-info');\n\n    el._userInfo = userInfo;\n\n    const signIn = doc.createElement('a');\n    signIn.innerText = 'Sign In';\n    signIn.setAttribute('slot', 'login');\n    signIn.addEventListener('click', () => {\n        authn.login();\n    });\n\n    const signOut = doc.createElement('a');\n    signOut.innerText = 'Sign Out';\n    signOut.setAttribute('slot', 'logout');\n    signOut.addEventListener('click', () => {\n        authn.logout();\n    });\n\n    userInfo.appendChild(signIn);\n    userInfo.appendChild(signOut);\n\n    el.appendChild(userInfo);\n}\n"],"names":["authn.AuthenticationObserver","state","token","user","authn.login","authn.logout"],"mappings":"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"}